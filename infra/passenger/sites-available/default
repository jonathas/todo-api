
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	server_name _;

	return 301 https://$host$request_uri;
}

server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;

	server_name _;
	
	passenger_enabled on;
	passenger_restart_dir /tmp;
	passenger_min_instances 5;
	passenger_max_request_queue_size 65536;
	
	# Hide headers for improved security
	server_tokens off;
	more_clear_headers "Server";
	more_clear_headers X-Powered-By;
	
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	gzip off;

	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	
	# support only known-secure cryptographic protocols
	# SSLv3 is broken by POODLE as of October 2014
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	
	# make the server choose the best cipher instead of the browser
	# Perfect Forward Secrecy(PFS) is frequently compromised without this
	ssl_prefer_server_ciphers on;
	
	# support only believed secure ciphersuites using the following priority:
	# 1.) prefer PFS enabled ciphers
	# 2.) prefer AES128 over AES256 for speed (AES128 has completely adequate security for now)
	# 3.) Support DES3 for IE8 support
	#
	# disable the following ciphersuites completely
	# 1.) null ciphers
	# 2.) ciphers with low security
	# 3.) fixed ECDH cipher (does not allow for PFS)
	# 4.) known vulnerable cypers (MD5, RC4, etc)
	# 5.) little-used ciphers (Camellia, Seed)
	ssl_ciphers 'kEECDH+ECDSA+AES128 kEECDH+ECDSA+AES256 kEECDH+AES128 kEECDH+AES256 kEDH+AES128 kEDH+AES256 DES-CBC3-SHA +SHA !aNULL !eNULL !LOW !kECDH !DSS !MD5 !EXP !PSK !SRP !CAMELLIA !SEED';

	# Use 2048 bit Diffie-Hellman RSA key parameters
	# (otherwise Nginx defaults to 1024 bit, lowering the strength of encryption # when using PFS)
	# Generated by OpenSSL with the following command:
	# openssl dhparam -outform pem -out /etc/ssl/certs/dhparam2048.pem 2048
	ssl_dhparam /etc/ssl/private/dhparam2048.pem;
	
    # CORS
	add_header 'Access-Control-Allow-Origin' '*';

	# enable HSTS including subdomains
	add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload';
	
	add_header X-Content-Type-Options nosniff;
	add_header X-DNS-Prefetch-Control off;
	add_header X-Download-Options noopen;
	add_header X-Frame-Options SAMEORIGIN;
	add_header X-XSS-Protection '1; mode=block';

    # CSP header
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' www.google-analytics.com ajax.googleapis.com; img-src 'self' data:; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com data:";
	
	# allow Nginx to send OCSP results during the connection process
	ssl_stapling on;

	# Self signed certs
	# Don't use them in a production server!
	ssl_certificate /etc/ssl/private/test/cert.pem;
	ssl_certificate_key /etc/ssl/private/test/key.pem;

	# ssl_certificate /etc/ssl/private/bundle.crt;
	# ssl_certificate_key /etc/ssl/private/certificate.key;
	
	location / {
		root /home/app/html;
		index index.html index.htm;
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}
	
	location /api {
		root /home/app/api/bin;
		passenger_nodejs /usr/bin/node;
		passenger_app_type node;
		passenger_app_root /home/app/api/bin;
		passenger_startup_file server.js;
		passenger_user app;
	}
	
	location ~ (\.env) {
    	return 404;
	}
	location /maps/ {
		return 404;
	}

}

passenger_socket_backlog 65536;
passenger_core_file_descriptor_ulimit 65536;
passenger_max_pool_size 5;
passenger_pre_start https://$host/api:443;
passenger_pool_idle_time 300; # 5 minutes
